<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sapper</title>
    <script src="create_table.js"></script>
    <link rel="stylesheet" href="sapper.css">
</head>
<body>
    <div id="start-window">
        <p id="start-message">Welcome, sapper! We need your help... Choose your skills and get started.</p>
        <ul id="start-list">
            <li class="start-list-item">
                <a href="#!" class="level" data-column="8" data-row="8" data-mine="10">Young sapper (8x8)</a>
            </li>

            <li class="start-list-item">
                <a href="#!" class="level" data-column="15" data-row="15" data-mine="40">Experienced sapper (15x15)</a>
            </li>

            <li class="start-list-item">
                <a href="#!" class="level" data-column="30" data-row="20" data-mine="100">Professional sapper (20x30)</a>
            </li>

            <li class="start-list-item">
                <a href="#!" id="start-btn">Start</a>
            </li>
        </ul>
    </div>
    <div id="game-filed" hidden>
        <div id="status" hidden>
            <div id="closeStatus">&#10006;</div>
        </div>
        <div id="timer">30:00</div>
        <div id="container"></div>
        <div id="lower-menu">
            <a href="#!" id="hint" title="Show bombs on click">&#128270;</a>
            <a href="#!" id="new-game">New Game</a>
        </div>
    </div>
    <script>
        startGame();
        
        function startGame() {
            let startBtn = document.getElementById('start-btn');
            let levels = document.getElementsByClassName('level');
            let startWindow = document.getElementById('start-window');
            let gameFiled = document.getElementById('game-filed');
            let hint = document.getElementById('hint');
            let restartBtn = document.getElementById('new-game');
            let container = document.getElementById('container');
            let timer = document.getElementById('timer');
            let status = document.getElementById('status');
            let closeStatus = document.getElementById('closeStatus');
            
            for (let level of levels) {
                level.addEventListener('click', function(){
                    
                    for (let level of levels) {
                        level.dataset.picked = false;
                    }
                    this.dataset.picked = true;
                });
            }
            
            startBtn.addEventListener('click', function(){
                for (let level of levels) {
                    if (level.dataset.picked == 'true'){
                        let table = createTable(level.dataset.column, level.dataset.row, level.dataset.mine);
                        container.append(table);
                        startWindow.style.display = 'none';
                        gameFiled.classList.add('field');

                        setTimer(gameFiled, container, timer, table, restartBtn);
                        addHint(hint, table, 'mousedown', '*');
                        addHint(hint, table, 'mouseup', '');
                    }
                }
            });
            restartBtn.addEventListener('click', function() {
                startWindow.style.display = 'flex';
                container.removeChild(container.firstChild);
                gameFiled.classList.remove('field');
                status.innerHTML = '';
                status.append(closeStatus);
                status.classList.remove('msgWindow');
            })
        }

        function addHint(hint, table, event, content) {
            hint.addEventListener(event, function() {
                if (table.dataset.win == undefined) {
                    let tds = table.querySelectorAll('td');
    
                    for (let td of tds) {
                        if (td.dataset.bomb == 'true') {
                            td.innerHTML = content;
                        }
                    }
                }
            });
        }

        function setTimer(gameFiled, container, timer, table, restartBtn) {
            let time = timer.innerHTML.split(':');
            let minutes = +time[0];
            let seconds = +time[1];
            
            let interv = setInterval(() => {
                
                if (seconds == 0 && minutes != 0) {
                    minutes--;
                    seconds = 59;
                } 
                else if (table.dataset.win != undefined) {
                    clearInterval(interv);
                    showGameStatus(table.dataset.win, minutes, seconds)
                } 
                else if (seconds == 0 && minutes == 0 ) {
                    clearInterval(interv);

                    let clone = table.cloneNode(true);
                    container.removeChild(container.firstChild);
                    container.appendChild(clone);
                    showGameStatus('time-is-out', minutes, seconds);
                }
                else {
                    seconds--;
                }
                
                timer.innerHTML = addZero(minutes) + ':' + addZero(seconds);

                restartBtn.addEventListener('click', function restartTimer() {
                        clearInterval(interv);
                        timer.innerHTML = '30:00';
                        restartBtn.removeEventListener('click', restartTimer);
                });

            }, 1000);
        }
        function addZero(num) {
            let length = num.toString().length;

            if (length == 1) {
                return num = '0' + num; 
            } 
            return num;
        }

        function showGameStatus(state, minutes, seconds) {
            let status = document.getElementById('status');
            let closeStatus = document.getElementById('closeStatus');
            let phrases = [];
            let efficiency = countEfficency(minutes, seconds);

            status.classList.add('msgWindow');

            if (state == 'win') {
                phrases = [`Congradulations!`, `You\'ve cleared all the field.`, 
                    `Your time: ${minutes} minutes and ${seconds} seconds`,
                    `Your efficiency: ${efficiency}%`,
                    `Press "New Game" to clear another field.`
                ]

            } else if (state == 'lose') {
                phrases = ['You\'ve detonated the bomb, sapper... Press "New Game" and practice.'];

            } else if (state == 'time-is-out') {
                phrases = ['Your time is out... Press "New Game" and play again.'];
            }
            let text = getTextElems(phrases);
            status.append(text);

            closeStatus.addEventListener('click', closeMsgWindow);
        }
        function countEfficency(minutes, seconds){
            let passed = +minutes * 60 + +seconds;
            let total = 30 * 60;
            let diff = total - passed;
            let efficiency = 100 - (diff * 100 / total).toFixed(1);
            return efficiency;
        }

        function getTextElems(phrases) {
            let text = document.createElement('div');
            text.id = 'text';

            for (const phrase of phrases) {
                let p = document.createElement('p');
                p.innerHTML = phrase;
                text.appendChild(p);
            }
            return text;
        }

        function closeMsgWindow() {
            let window = this.closest('#status');
            window.classList.remove('msgWindow');
        }
    </script>
</body>
</html>
